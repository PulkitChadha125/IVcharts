<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IV Charts - Implied Volatility Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h1>IV Charts</h1>
            </div>
            <nav class="nav-menu">
                <a href="#" class="nav-item active">Dashboard</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <h2>Dashboard</h2>
                </div>
                <div class="header-right">
                    <button id="loginBtn" class="btn-primary" onclick="if(window.loginToAPI) window.loginToAPI(); else alert('Login function not loaded. Please refresh the page.');">Login to API</button>
                    <div class="user-profile">
                        <div class="profile-icon">ðŸ‘¤</div>
                    </div>
                </div>
            </header>

            <!-- Login Status -->
            <div id="loginStatus" class="status-card" style="display: none;">
                <span class="status-indicator"></span>
                <span id="statusText">Logged in</span>
            </div>

            <!-- Settings Section -->
            <div id="settingsSection" class="settings-section" style="display: none;">
                <div class="settings-card">
                    <h3>Settings</h3>
                    
                    <!-- Mode Selection -->
                    <div class="settings-row">
                        <div class="input-group">
                            <label for="mode">Selection Mode</label>
                            <select id="mode" onchange="toggleMode()">
                                <option value="manual">Manual Selection</option>
                                <option value="automatic" selected>Automatic Selection</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="timeframe">Timeframe</label>
                            <select id="timeframe">
                                <option value="1s">1 Second</option>
                                <option value="1" selected>1 Minute</option>
                                <option value="5">5 Minutes</option>
                                <option value="15">15 Minutes</option>
                                <option value="30">30 Minutes</option>
                                <option value="60">1 Hour</option>
                                <option value="120">2 Hours</option>
                                <option value="1D">1 Day</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="riskFreeRate">Risk-Free Rate (%)</label>
                            <input type="number" id="riskFreeRate" placeholder="10" value="10" step="0.01" min="0" max="100">
                        </div>
                        <div class="input-group">
                            <label for="maxCandles">Max Candles/Data Points</label>
                            <input type="number" id="maxCandles" placeholder="50000" value="50000" step="1000" min="50" max="100000" title="Maximum number of data points to display on chart (set high to show all CSV rows)">
                        </div>
                    </div>
                    
                    <!-- Manual Mode Fields -->
                    <div id="manualModeFields">
                        <div class="settings-row">
                            <div class="input-group">
                                <label for="symbol">Symbol</label>
                                <input type="text" id="symbol" placeholder="e.g., NSE:NIFTY25N1825500CE" value="NSE:NIFTY25N1825500CE">
                            </div>
                        </div>
                        <div class="settings-row">
                            <div class="input-group">
                                <label for="strike">Strike Price (Optional)</label>
                                <input type="number" id="strike" placeholder="e.g., 18257" step="0.01">
                            </div>
                            <div class="input-group">
                                <label for="expiry">Expiry Date & Time (Optional)</label>
                                <input type="datetime-local" id="expiry">
                            </div>
                            <div class="input-group">
                                <label for="optionType">Option Type (Optional)</label>
                                <select id="optionType">
                                    <option value="">Auto-detect</option>
                                    <option value="c">Call (CE)</option>
                                    <option value="p">Put (PE)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Automatic Mode Fields -->
                    <div id="automaticModeFields">
                        <div class="settings-row">
                            <div class="input-group">
                                <label for="futureSymbol">Future Symbol</label>
                                <select id="futureSymbol" onchange="onFutureSymbolChange()">
                                    <option value="">Loading symbols...</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="expiryType">Expiry Type</label>
                                <select id="expiryType">
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly" selected>Monthly</option>
                                </select>
                            </div>
                        </div>
                        <div class="settings-row">
                            <div class="input-group">
                                <label for="autoExpiryDate">Option Expiry Date</label>
                                <input type="date" id="autoExpiryDate">
                            </div>
                            <div class="input-group">
                                <label for="autoOptionType">Option Type</label>
                                <select id="autoOptionType">
                                    <option value="c" selected>Call (CE)</option>
                                    <option value="p">Put (PE)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="strikeStep">Strike Step</label>
                                <input type="number" id="strikeStep" placeholder="Auto" step="1" min="1" title="Strike interval (e.g., 50 for NIFTY, 100 for BANKNIFTY). Auto-filled from symbol settings.">
                                <small style="color: #a0c4ff; display: block; margin-top: 4px;">Auto-filled from symbol settings</small>
                            </div>
                        </div>
                        <div class="settings-row">
                            <div class="info-box" style="background: #1e3a5f; padding: 10px; border-radius: 4px; margin-top: 10px;">
                                <small style="color: #a0c4ff;">
                                    <strong>Automatic Mode:</strong> System will fetch future LTP every 1 second, calculate ATM strike (rounded to nearest strike step), 
                                    generate option contract symbol, and plot IV chart automatically.
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <div class="button-group">
                            <button id="startBtn" class="btn-success" onclick="startFetching()">Start Fetching</button>
                            <button id="stopBtn" class="btn-danger" onclick="stopFetching()">Stop Fetching</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs Section -->
            <div class="logs-section" style="margin-bottom: 20px;">
                <div class="settings-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">Application Logs</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="logLevelFilter" onchange="loadLogs()" style="padding: 6px 10px; background: #1e3a5f; border: 1px solid #3a5f8f; border-radius: 4px; color: #a0c4ff; font-size: 13px;">
                                <option value="">All Levels</option>
                                <option value="ERROR">Errors Only</option>
                                <option value="WARNING">Warnings</option>
                                <option value="INFO">Info</option>
                                <option value="DEBUG">Debug</option>
                            </select>
                            <button onclick="loadLogs()" class="btn-primary" style="padding: 6px 12px; font-size: 13px;">Refresh</button>
                            <button onclick="clearLogs()" class="btn-danger" style="padding: 6px 12px; font-size: 13px;">Clear Logs</button>
                        </div>
                    </div>
                    <div id="logsContainer" style="background: #0f1e2e; border: 1px solid #3a5f8f; border-radius: 4px; padding: 15px; max-height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
                        <div style="color: #a0c4ff; text-align: center; padding: 20px;">Loading logs...</div>
                    </div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="chart-section">
                <div class="chart-card" style="position: relative;">
                    <div class="chart-header">
                        <h3>
                            <span id="chartContractName" style="color: #a0c4ff; font-weight: bold;"></span>
                            <span id="chartTitle">Implied Volatility Chart</span>
                        </h3>
                        <div class="chart-controls">
                            <span id="fetchStatus" class="status-badge">Stopped</span>
                            <button id="resetZoomBtn" class="btn-reset" title="Reset Zoom (Double-click chart)">Reset Zoom</button>
                        </div>
                    </div>
                    <div class="chart-hint">
                        <small>ðŸ’¡ Scroll to zoom | Click and drag to pan | Double-click to reset | Mouse wheel on price scale to zoom Y-axis</small>
                    </div>
                    <!-- Crosshair Tooltip - positioned outside chart container to avoid z-index issues -->
                    <div id="crosshairTooltip" style="display: none; position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(30, 58, 95, 0.98); border: 1px solid #3a5f8f; border-radius: 6px; padding: 12px 16px; z-index: 10000; min-width: 320px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); pointer-events: none;">
                        <div style="display: flex; justify-content: space-between; gap: 24px; font-size: 13px;">
                            <div>
                                <div style="color: #a0c4ff; margin-bottom: 4px; font-size: 11px;">IV Value:</div>
                                <div style="color: #fff; font-weight: bold; font-size: 14px;" id="tooltipIV">-</div>
                            </div>
                            <div>
                                <div style="color: #a0c4ff; margin-bottom: 4px; font-size: 11px;">Option Price:</div>
                                <div style="color: #fff; font-weight: bold; font-size: 14px;" id="tooltipOptionPrice">-</div>
                            </div>
                            <div>
                                <div style="color: #a0c4ff; margin-bottom: 4px; font-size: 11px;">Underlying Price:</div>
                                <div style="color: #fff; font-weight: bold; font-size: 14px;" id="tooltipUnderlyingPrice">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container" style="position: relative;">
                        <div id="ivChart"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="{{ url_for('static', filename='js/tradingview-chart.js') }}"></script>
    <script>
        // Ensure loginToAPI is available immediately when script loads
        // This runs before DOMContentLoaded, so the function is available for any early clicks
        console.log('Script loaded, checking loginToAPI availability...');
    </script>
</body>
</html>

